---
title: "How neotropical tree behave in monospecific timber plantation : case study of Bagasse, Angélique and Yayamadou"
author:
  - name: "Maël Leborgne"
    authsuperscript: 1*
    orcid: 0000-0000-0000-0000
  - name: "Rozenn Bourquin"
    authsuperscript: 2
affiliation:
  - affsuperscript: 1
    dptuniv: "Department / University"
    address: >
      Street address,
      Zip code,
      Country.
  - affsuperscript: 2
    dptuniv: "Department / University"
    address: >
      Street address,
      Zip code,
      Country.
corrauthor:
    email: name@company.com
    url: https://www.company.com
abstract: >
  Summary of the article.
  Mandatory.
  
  
  Use double line feed for a new paragraph.
keywords: [keyword1, keyword2, etc]
JEL: [Code1, Code2, etc, MayBeDeleted]
acknowledgements: >
  Acknowledgements. 
  
  
  May be deleted.
journalinfo: "Publication reference"
archive: "DOI: xxx/xx"
# Date format: '%Y %B %d' for distill
date: "`r format(Sys.time(), '%Y %B %d')`"
url: https://GitHubID.github.io/Repository/
github-repo: GitHubID/Repository
lang: en-US
otherlangs: [fr-FR,it]
keywordlabel: Keywords
JELlabel: JEL
acknowledgementslabel: Acknowledgements
corrauthorlabel: Corresponding author
# Author separator: \par (no quote) for one author per line, "," (between quotes) else
authorseparator: \par
bibliography: references.bib
biblio-style: chicago
toc-depth: 3
fontsize: 10pt
urlcolor: blue
preamble: >
  \hyphenation{bio-di-ver-si-ty sap-lings}
always_allow_html: yes
csquotes: true
output:
  bookdown::html_document2:
    base_format: distill::distill_article
    toc: yes
    toc_float: yes
    code_folding: show
    highlight_downlit: yes
  rmdformats::downcute:
    use_bookdown: yes
    lightbox: yes
  bookdown::gitbook:
    config:
      download: "pdf"
      sharing:
        github: yes
  bookdown::pdf_book:
    template: latex/template.tex
    citation_package: natbib
    latex_engine: xelatex
    keep_tex: yes
  bookdown::word_document2: default
editor_options: 
  markdown: 
    wrap: sentence
---

```{r}
#| label: DoNotModify
#| include: false
### Utilities. Do not modify.
# Installation of packpred if necessary
install_packpred <- function(packpred) {
  install_package <- function(package) {
    if (!package %in% installed.packages()[, 1]) {
      install.packages(package, repos = "https://cran.rstudio.com/")
    }
  }
  invisible(sapply(packpred, install_package))
}

# Basic packpred
install_packpred(c("bookdown", "formatR", "kableExtra", "ragg"))

# Chunk font size hook: allows size='small' or any valid Latex font size in chunk options
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(
    options$size != "normalsize", 
    paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), 
    x
  )
})
```

```{r}
#| label: Options
#| include: false
### Customized options for this document
# Add necessary packpred here
packpred <- c("tidyverse")
# Install them
install_packpred(packpred)

# knitr options
knitr::opts_chunk$set(
  cache =   FALSE,    # Cache chunk results
  include = TRUE,     # Show/Hide chunks
  echo =    TRUE,     # Show/Hide code
  warning = FALSE,    # Show/Hide warnings
  message = FALSE,    # Show/Hide messpred
  # Figure alignment and size
  fig.align = 'center', out.width = '80%',
  # Graphic devices (ragg_png is better than standard png)
  dev = c("ragg_png", "pdf"),
  # Code chunk format
  tidy = TRUE, tidy.opts = list(blank = FALSE, width.cutoff = 50),
  size = "scriptsize", knitr.graphics.auto_pdf = TRUE
  )
options(width = 50)

# ggplot style
library("tidyverse")
theme_set(theme_bw())
theme_update(
  panel.background = element_rect(fill = "transparent", colour = NA),
  plot.background = element_rect(fill = "transparent", colour = NA)
)
knitr::opts_chunk$set(dev.args = list(bg = "transparent"))

# Random seed
set.seed(973)
```

# Data Importation

```{r}
#| echo: false
library(tidyverse)
library(ggplot2)
library(BIOMASS)

# ---- Historical data ----
Inv_complet <- read.csv2("/home/jean/Bureau/projet-ONF-FTH/Data/Rozeen_30-10_DataPlantations_sansBR.csv", sep=";",dec = ",")

# ---- Add Last data (2025) ---- TODO

# ---- Age_Plantation : Convertion en années ----
convert_annee <- data.frame(
  "Age_Plantation" = unique(Inv_complet$Age_Plantation),
  "Age_Plantation_annee" = c(35,0,0.5,1,1.5,2,3,5,8,9,14,7,36,46,3.5,4,6,10.5,2.5,0,34,20,40,0.25,15,0.75,0.917,1.083,1.5,10,0.583,23,7,41,13,4.5)
)
Inv_complet <- left_join(Inv_complet,convert_annee,by="Age_Plantation")

# ---- Ht_mesure : Set at 130 when == 0 ----
Inv_complet <- Inv_complet %>%
  mutate(Ht_Mesure = ifelse(Ht_Mesure == 0, 130, Ht_Mesure))

# ---- DBH : Correction for Ht_mesure != 130 ----
Inv_complet <- Inv_complet |>
  mutate(DBH = round(Circonférence/pi),digits=2) |>
  mutate(POM = Ht_Mesure) |>
  mutate(Taper_parameter = 0.156 - 0.023*log(DBH) - 0.021*log(POM/100)) |>
  mutate(DBHCorr = DBH/(exp(- Taper_parameter*((POM-130)/100))))

# ---- DBHCorr = 0 if DBH = 0 ----
Inv_complet <- Inv_complet %>%
  mutate(DBHCorr = ifelse(DBH == 0, 0, DBHCorr))

# ---- as.factor for selected variables
Inv_complet$Code_Essence <- as.factor(Inv_complet$Code_Essence)
Inv_complet$Age_Plantation_annee <- as.factor(Inv_complet$Age_Plantation_annee)

# ---- Result ----
str(Inv_complet)


```

## Selection of species and sites

```{r}

# ---- Selection of species ----
data_selection <- Inv_complet[Inv_complet$Nom_Vernaculaire %in% c("angelique","bagasse","yayamadou marecage"),]

# # ---- Selection of sites ----
# # Liste de combinaisons à exclure sous forme de vecteur (site, essence)
# excluded_combinations <- data.frame(
#   Nom_Vernaculaire = c("angelique", "angelique", "angelique", "angelique", "bagasse", "bagasse", "bagasse"),
#   Libelle_Plantation = c("CHR02_A", "KAW03_D", "MDF01_A", "MDF01_D", "CHR02_A", "KAW03_A", "PAR19_D")
# )
# 
# # Créer directement la colonne combinée 'combination' avec paste()
# excluded_combinations$combination <- paste(excluded_combinations$Libelle_Plantation, excluded_combinations$Nom_Vernaculaire)
# 
# # Filtrage des combinaisons à exclure
# data_selection <- data_selection %>%
#   mutate(combination = paste(Libelle_Plantation, Nom_Vernaculaire)) %>%  # Créer la colonne de combinaison
#   filter(!combination %in% excluded_combinations$combination) %>%  # Exclure les combinaisons
#   select(-combination)

# ---- Split Libelle_Plantation ----
data_selection <- data_selection %>%
  mutate(Localisation = substr(Libelle_Plantation, 1, 3)) %>% # Split name
  mutate(Plot = substr(Libelle_Plantation, 4,nchar(Libelle_Plantation))) # Split name

# ---- Result ----
data_selection
```

# Data Exploration

## Sample table and dates

```{r}
#| echo: false

# ---- Mat&Meth : Summary of tree inventories (Date and number of individuals) ----

# # RESOUDRE LE PROBLÈME NB ARBRE AU LIEU DE NB MESURE
# df_sp_plantation <- data_selection %>%
#   group_by("Localisation", "Nom_Vernaculaire","Arbre") %>%
#   summarise()

# ---- Count table per sites and species ----
df_sp_plantation <- data_selection %>% 
  select("Localisation", "Nom_Vernaculaire") %>%
  table() %>% 
  addmargins() %>% 
  as.data.frame() %>%
  pivot_wider(names_from = Nom_Vernaculaire, values_from = Freq)

# ---- Extract Year for each subplots ----
df_year_plantation <- data_selection %>%
  mutate(Age_Plantation_annee = as.numeric(Age_Plantation_annee)) %>% # Age in numeric
  group_by(Localisation) %>%         # For each Plot-Subplot
  arrange(Age_Plantation_annee) %>%        # arrange dates by Year trough inventories
  slice_head(n = 1) %>%                    #!# keep the oldest date possible 
  ungroup() %>%                            # Enable selection
  select(Localisation,Date_Intervention,Age_Plantation_annee) %>% # Remove useless informations
  filter(!is.na(Localisation)) %>%   # Remove NA Plot-Subplot
  mutate(Year_of_plantation = as.integer(substr(Date_Intervention, 1, 4))) %>% # Extract the year
  select(-Date_Intervention) %>%           # Date become useless 
  group_by(Localisation) %>%         # For each Plot-Subplot
  mutate(Year_of_plantation = min(Year_of_plantation)) %>%    #!# keep the minimal year
  ungroup() %>%                            # Enable selection
  mutate(Year_of_plantation = Year_of_plantation - Age_Plantation_annee) %>% # Correction of plantation years with age of tree on first inventory
  select(-Age_Plantation_annee) %>% # Age become useless
  mutate(Age_of_trees = 2025 - Year_of_plantation) # Add trees age

# ---- Join count table and years df ----
df_summary_plantation <- left_join(df_sp_plantation,df_year_plantation,by="Localisation")

# # ---- Complete name of des site de plantations ---- TODO
# df_name_plantation <- data.frame(
#   "Libelle_simplified" = c("RIS","TON","MDF","CHR","KAW","TOUL","CAC","PAR"),
#   "Name" = c("","Tonnegrande","MDF","Christine","Kaw","Toulouri","","Paracou")
# )

# ---- New order of colonnes and rows ----
df_summary_plantation <- df_summary_plantation[, c("Localisation","Year_of_plantation","Age_of_trees", "angelique","bagasse","yayamadou marecage")]  %>%
  arrange(Year_of_plantation)

# ---- Result ----
print(df_summary_plantation)
```

## DBH (exploration)

```{r}
#| echo: false

# ---- Selection of columns ----
select_col_sp <- data.frame(
  "arbre" = data_selection$Code_Arbre,
  "diam" = data_selection$DBHCorr,
  "Htot" = data_selection$Hauteur_Totale,
  "essence" = as.factor(data_selection$Nom_Vernaculaire), # as factor
  "age" = as.factor(data_selection$Age_Plantation_annee), # converted in year
  "site" = as.factor(data_selection$Localisation),
  "etat" = data_selection$Etat_Sanitaire
) %>% filter(!is.na(site)) %>% # remove NA site
  filter(etat != 5) # remove dead trees

# ---- angelique ----
ggplot(data = select_col_sp[select_col_sp$essence=="angelique",], aes(x = age, y = diam, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "DBH (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r}
#| echo: false

# ---- bagasse ----
ggplot(data = select_col_sp[select_col_sp$essence=="bagasse",], aes(x = age, y = diam, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "DBH (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r}
#| echo: false

# ---- yayamadou marecage ----
ggplot(data = select_col_sp[select_col_sp$essence=="yayamadou marecage",], aes(x = age, y = diam, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "DBH (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## Total Heigth (exploration)

```{r}
#| echo: false

# ---- angelique ----
ggplot(data = select_col_sp[select_col_sp$essence=="angelique",], aes(x = age, y = Htot, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "Total Height (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r}
#| echo: false

# ---- bagasse ----
ggplot(data = select_col_sp[select_col_sp$essence=="bagasse",], aes(x = age, y = Htot, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "Total Height (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r}
#| echo: false

# ---- yayamadou marecage ----
ggplot(data = select_col_sp[select_col_sp$essence=="yayamadou marecage",], aes(x = age, y = Htot, color = essence)) +
  geom_boxplot() +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "Total Height (cm)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

# Biomasse Estimation

## Filtering

### **Htot \~ DBH plot**

```{r}

# ---- PLOT ----
ggplot(data_selection, aes(x = DBHCorr, y = Hauteur_Totale, color = Nom_Vernaculaire)) +
  geom_point(size = 0.5) +  # Créer un nuage de points
  labs(title = "Hauteur Totale vs DBH Corrigé",
       x = "DBH Corrigé (cm)",
       y = "Hauteur Totale (m)") +
  theme_minimal() +       # Utiliser un thème minimal
  theme(legend.title = element_text(size = 12), 
        legend.text = element_text(size = 10))  # Personnaliser la légende

```

### **Filter and new** **Htot \~ DBH plot**

```{r}

# ---- Filter ----
filtered_data_selection <- data_selection %>% 
  filter(!is.na(Localisation)) %>% # remove NA site
  filter(Etat_Sanitaire != 5) %>% # remove dead trees
  filter(!is.na(DBHCorr)) %>% # remove NA from DBH
  filter(Hauteur_Totale>0) %>% # remove 0 from DBH
  filter(DBH>0) # remove 0 from Htot

# ---- PLOT ----
ggplot(filtered_data_selection, aes(x = DBHCorr, y = Hauteur_Totale, color = Nom_Vernaculaire)) +
  geom_point(size = 0.5) +  # Créer un nuage de points
  labs(title = "Hauteur Totale vs DBH Corrigé",
       x = "DBH Corrigé (cm)",
       y = "Hauteur Totale (m)") +
  theme_minimal() +       # Utiliser un thème minimal
  theme(legend.title = element_text(size = 12), 
        legend.text = element_text(size = 10))  # Personnaliser la légende
```

## Density and Biomass

```{r}
library(BIOMASS)

# --- For each row of inventory : Add Wood Density and Biomass ----
filtered_data_selection <- filtered_data_selection %>% 
  mutate(Wood_Density = getWoodDensity(Genre, Espece)$meanWD) %>% # Wood Density
  # BIOMASS estimation (ton)
  mutate(AGB_ton = computeAGB(D = DBHCorr, H = Hauteur_Totale/100, WD = Wood_Density)) %>%
  mutate(AGB_kg = AGB_ton*1000) # convertion in kg

 # ---- Result ----
filtered_data_selection

```

## Biomass plots

### Angélique

```{r}
# ---- Selection ----
df <- filtered_data_selection[filtered_data_selection$Nom_Vernaculaire=="angelique",]

# ---- Plots ----
ggplot(data = df, aes(x = Age_Plantation_annee, y = AGB_kg, color = Nom_Vernaculaire)) +
  geom_boxplot() +
  facet_wrap(~Localisation, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "AGB (kg)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

### Bagasse

```{r}
# ---- Selection ----
df <- filtered_data_selection[filtered_data_selection$Nom_Vernaculaire=="bagasse",]

# ---- Plots ----
ggplot(data = df, aes(x = Age_Plantation_annee, y = AGB_kg, color = Nom_Vernaculaire)) +
  geom_boxplot() +
  facet_wrap(~Localisation, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "AGB (kg)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

### Yayamadou marécage

```{r}
# ---- Selection ----
df <- filtered_data_selection[filtered_data_selection$Nom_Vernaculaire=="yayamadou marecage",]

# ---- Plots ----
ggplot(data = df, aes(x = Age_Plantation_annee, y = AGB_kg, color = Nom_Vernaculaire)) +
  geom_boxplot() +
  facet_wrap(~Localisation, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "AGB (kg)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

# Biomass accumulation rate

## BAR and BAR per species

```{r}

# ---- Calculation of intantateous rate ---

filtered_data_selection <- filtered_data_selection %>%
  mutate(Age_Plantation_annee = as.numeric(Age_Plantation_annee)) %>% # Age as.numeric
  mutate(BAR = AGB_kg / Age_Plantation_annee) %>% # Calcul of rate
  mutate(Age_Plantation_annee = as.factor(Age_Plantation_annee)) # Age as.factor

# ---- Selection ----
df <- filtered_data_selection

# ---- Plots ----
ggplot(data = filtered_data_selection, aes(x = Nom_Vernaculaire, y = AGB_kg, color = Nom_Vernaculaire)) +
  geom_boxplot() +
  #facet_wrap(~Localisation, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "BAR (kg/year)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))+
  coord_cartesian(ylim = c(0, 600))


```

### plot BAR/ABG

```{r}
df <- filtered_data_selection[filtered_data_selection$Nom_Vernaculaire=="bagasse",]

# ---- PLOT ----
ggplot(df, aes(x = AGB_kg, y = BAR, color = Nom_Vernaculaire)) +
  geom_point(size = 0.5) +  # Créer un nuage de points
  labs(title = "Hauteur Totale vs DBH Corrigé",
       x = "DBH Corrigé (cm)",
       y = "Hauteur Totale (m)") +
  theme_minimal() +       # Utiliser un thème minimal
  theme(legend.title = element_text(size = 12), 
        legend.text = element_text(size = 10))  # Personnaliser la légende

# PLUS L'ARBRE À DE LA BIOMASSE PLUS IL EST RAPIDE À EN PRODUIRE (LINEAIRE)

# ON NE PEUT PAS COMPARER DES PARCELLES À DES AGES DIFFÉRENTS
```

### plot pm/AGB

```{r}
data_selection <- data_selection %>%
  filter(Etat_Sanitaire != 6)

df <- data_selection %>%
  group_by(Age_Plantation_annee,Nom_Vernaculaire) %>%
  summarise(mean_AGB_age = mean(BAR, na.rm = TRUE),Age=unique(Age_Plantation_annee))

mortalite_par_annee <- data_selection %>%
  group_by(Nom_Vernaculaire, Age_Plantation_annee) %>%
  summarise(
    survie = if_else(Etat_Sanitaire %in% 1:4,0,1),
    nb_total = n(),
    nb_morts = sum(survie),
    proportion_mort = nb_morts / nb_total
  ) %>%
  arrange(Nom_Vernaculaire, Age_Plantation_annee)


ggplot(df, aes(x = AGB_kg, y = pm, color = Nom_Vernaculaire)) +
  geom_point(size = 0.5) +  # Créer un nuage de points
  labs(title = "Hauteur Totale vs DBH Corrigé",
       x = "DBH Corrigé (cm)",
       y = "Hauteur Totale (m)") +
  theme_minimal() +       # Utiliser un thème minimal
  theme(legend.title = element_text(size = 12), 
        legend.text = element_text(size = 10))  # Personnaliser la légende
```

## Compare mean_BAR per localisation

```{r}

# ---- Add mean Biomass accumulation rate ----
filtered_data_selection <- filtered_data_selection %>%
  group_by(Localisation, Nom_Vernaculaire) %>%
  mutate(
    mean_BAR = mean(BAR, na.rm = TRUE),
    Combinaison = paste(Localisation, Nom_Vernaculaire, sep = " - ")
    ) %>%
  ungroup()
  
# ---- Arrange data by specie and increasing mean_BAR ----
filtered_data_selection <- filtered_data_selection %>%
  arrange(Nom_Vernaculaire, mean_BAR) %>%
  mutate(order_sp = as.factor(dense_rank(Nom_Vernaculaire))) %>%
  group_by(Nom_Vernaculaire) %>%
  mutate(order_BAR = as.factor(dense_rank(mean_BAR))) %>%
  ungroup() %>%
  # ranking for ploting order (1,1,2,3,3,3...)
  mutate(order_comb = as.factor(paste(order_sp, order_BAR, sep = "")))

# ---- Summary of mean per Localisation ----
df_summary_biomass <- filtered_data_selection %>% group_by(Combinaison) %>% summarise(mean_BAR = mean(BAR),order_comb = unique(order_comb),Localisation=unique(Localisation)) %>% arrange(order_comb)

# ---- Test statistiques ----
# Normality test
shapiro_results <- filtered_data_selection %>%
  group_by(order_comb) %>%
  summarise(
    shapiro_p_value = shapiro.test(BAR)$p.value
  )
print(shapiro_results) # p < 0.05 = on rejette H0 = distribution pas normale
# Wilcoxon pairwise test
pairwise_res <- pairwise.wilcox.test(filtered_data_selection$BAR, filtered_data_selection$order_comb, p.adjust.method = "bonferroni")
# Extraction of p-values
p_values <- pairwise_res$p.value
# Generate comparison lettres
library(multcompView)
cld_res <- multcompLetters(p_values)
# Add manualy the first letters and create a colonne of letters
df_summary_biomass$letters <- c("a",as.vector(cld_res$Letters))

# ---- Result ----
df_summary_biomass

# ---- Boxplot ----
ggplot(data = filtered_data_selection, aes(x = order_comb, y = BAR, color = Nom_Vernaculaire)) +
  geom_boxplot(outlier.shape = 1, outlier.size = 1) + # Add box
  # Add red point for mean values
  stat_summary(data = df_summary_biomass, aes(x = order_comb, y = mean_BAR), geom = "point", shape = 18, size = 4, color = "red") +
  labs( # Axis labels
    x = "Localisation",
    y = expression("Mean " ~ frac(delta*AGB, delta*dt) ~ "(kg.year⁻¹.tree⁻¹)"),
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14)  # Verticale orientation of x labels
    ) +  
  coord_cartesian(ylim = c(0, 40)) +
  scale_x_discrete(labels = df_summary_biomass$Localisation)+
  # Ajouter les lettres des résultats des tests
  geom_text(data = df_summary_biomass, aes(x = order_comb,y=mean_BAR+10, label = letters),
            color = "black", size = 4, vjust = -1,
            position = position_nudge(x = -0.2))  # Positionner les lettres au-dessus des boîtes

```

## Compare slopes by localisation

### Create Linear Model

```{r}
# ---- Add slope of Biomass accumulation rate ----
# Age as.numeric
filtered_data_selection <- filtered_data_selection %>%
  mutate(Age_Plantation_annee = as.numeric(Age_Plantation_annee))

# forcer les intercept à zero
lm_AGB <- lm(AGB_kg ~ 0 + Combinaison:Age_Plantation_annee, data = filtered_data_selection)
# lm_AGB <- glm(BAR ~ 0 + Age_Plantation_annee + Combinaison:Age_Plantation_annee, data = filtered_data_selection,family = Gamma())

summary(lm_AGB)
plot(lm_AGB)

# Slopes extracion
slope_summary <- filtered_data_selection %>% 
  group_by(Combinaison) %>% 
  summarise(
    Localisation = unique(Localisation),
    Nom_Vernaculaire = unique(Nom_Vernaculaire),
    Age_Plantation_annee=1 # the prediction for age = 1 is the intercept + slope
    )

coeff <- coefficients(lm_AGB)
intercept <- coeff["(Intercept)"][[1]]

# Prediction
slope_summary$slopes <- predict(lm_AGB, newdata = slope_summary)
slope_df <- as.data.frame(slope_summary) %>%
  arrange(Nom_Vernaculaire,slopes) %>%
  select(Combinaison,slopes) 
slope_summary <- as.data.frame(slope_summary) %>%
  arrange(Nom_Vernaculaire,slopes) %>%
  select(Nom_Vernaculaire,Localisation,slopes) %>%
  rename("AGB slopes (kg/year/tree)" = "slopes")


# ---- Result ----
slope_df
slope_summary

# ---- Add the slope to main dataframe ----
filtered_data_selection <- filtered_data_selection %>%
  left_join(slope_df, by = "Combinaison")
```

### Check Linear Model

```{r}
# ---- Prediction ---

# Creation of new data.frame for prediction
df_lm_pred <- filtered_data_selection %>% 
  group_by(Combinaison) %>% 
  summarise(
    Localisation = unique(Localisation),
    Nom_Vernaculaire = unique(Nom_Vernaculaire),
    Age_Plantation_annee = c(0,4,8,12,16,20) # Points of prediction
    )

# Prediction on new data
df_lm_pred$AGB <- predict(lm_AGB, newdata = df_lm_pred)
# # Convertir les prédictions sur l'échelle d'origine (décoder avec exp)
# df_lm_pred$AGB <- df_lm_pred$AGB  # Transformation inverse (lien log)

# # ---- Selection ----
# df <- filtered_data_selection[filtered_data_selection$Nom_Vernaculaire=="bagasse",]

# ---- Plots ----
ggplot(data = filtered_data_selection, aes(x = Age_Plantation_annee, y = AGB_kg, color = Nom_Vernaculaire)) +
  geom_point() +
  geom_line(
    data = df_lm_pred, 
    aes(x = Age_Plantation_annee, y = AGB, color = Nom_Vernaculaire)
    ) +
  geom_smooth(method = "lm", se=TRUE) +
  facet_wrap(~Combinaison, scales = "free_y") +
  labs(
    x = "Age (years)",
    y = "BAR (kg/year)",
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

### Comparison plot

```{r}

 # forcer les intercept à zero
lm_AGB_2 <- lm(BAR ~ 0 + Age_Plantation_annee + Combinaison:Age_Plantation_annee + Combinaison:Code_Arbre, data = filtered_data_selection)

# ---- Arrange data by specie and increasing slopes ----
filtered_data_selection <- filtered_data_selection %>%
  arrange(Nom_Vernaculaire, slopes) %>%
  mutate(order_sp = as.factor(dense_rank(Nom_Vernaculaire))) %>%
  group_by(Nom_Vernaculaire) %>%
  mutate(order_BAR = as.factor(dense_rank(slopes))) %>%
  ungroup() %>%
  # ranking for ploting order (1,1,2,3,3,3...)
  mutate(order_comb = as.factor(paste(order_sp, order_BAR, sep = "")))

# ---- Summary of mean per Localisation ----
df_summary_slopes <- filtered_data_selection %>% group_by(Combinaison) %>% summarise(slopes = unique(slopes),order_comb = unique(order_comb),Localisation=unique(Localisation))
  
# ---- Boxplot ----
ggplot(data = filtered_data_selection, aes(x = order_comb, y = slopes, color = Nom_Vernaculaire)) +
  geom_boxplot(outlier.shape = 1, outlier.size = 1) + # Add box
  # Add red point for mean values
  stat_summary(data = df_summary_slopes, aes(x = order_comb, y = slopes), geom = "point", shape = 18, size = 4, color = "red") +
  labs( # Axis labels
    x = "Localisation",
    y = expression("Slope " ~ frac(delta*AGB, delta*dt) ~ "(kg.year⁻¹.tree⁻¹)"),
    color = "Specie"
  ) +
  scale_color_manual(values = c("angelique" = "#8B0000", "yayamadou marecage" = "#00008B", "bagasse" = "#006400")) +  # Définir des couleurs spécifiques
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14)  # Verticale orientation of x labels
    ) +  
  coord_cartesian(ylim = c(0, 2)) +
  scale_x_discrete(labels = df_summary_biomass$Localisation)

```

## 2-way ANOVA model

```{r}

M0 <- glm(BAR ~ 1, data = filtered_data_selection,family=Gamma())
M1 <- glm(BAR ~ Nom_Vernaculaire, data = filtered_data_selection,family=Gamma())
M2 <- glm(BAR ~ Localisation, data = filtered_data_selection,family=Gamma())
M12 <- glm(AGB_kg ~ 0+Nom_Vernaculaire + Localisation, 
              data = filtered_data_selection, family=Gamma())
lm_M12 <- lm(AGB_kg ~ 0+Nom_Vernaculaire + Localisation, 
              data = filtered_data_selection)

anova(M0,M2,M12) 
# There is a significant effect of Localisation in the heart rate

# I can also see the result of the full model at the end of the summary
summary(M12)
# Yayamadou marecage is not significatively different than angelique for 
```

# TODO

-   Test Stat sur mean_BAR (add to graphique)

-   Vérifier si le LM est adapté

-   Try keep only last alive trees

-   Section on Proba survie / BAR

-   
